name: Deploy to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
        
    - name: Add VPS to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy to VPS
      run: |
        ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          set -e
          cd /opt/notionlock
          
          # Pull latest changes
          echo "üì• Pulling latest changes from GitHub..."
          git pull origin master
          
          # Show latest commits
          echo "üìù Latest commits:"
          git log --oneline -3
          
          # Copy production environment
          echo "üîß Setting up production environment..."
          cp .env_prod .env
          
          # Nuclear option: complete frontend rebuild
          echo "‚ò¢Ô∏è NUCLEAR REBUILD: Removing ALL frontend traces..."
          docker compose -f docker/docker-compose.yml stop frontend || true
          docker compose -f docker/docker-compose.yml rm -f frontend || true
          
          # Remove ALL related images
          echo "üóëÔ∏è Removing all notionlock images..."
          docker images | grep notionlock | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
          
          # Clean ALL docker cache
          echo "üßπ Nuclear cleaning of Docker cache..."
          docker builder prune -af || true
          docker system prune -f || true
          
          # Pull base images
          echo "üì• Pulling base images..."
          docker compose -f docker/docker-compose.yml pull postgres redis || true
          
          # Build frontend completely fresh
          echo "üî® Building frontend from absolute scratch..."
          DOCKER_BUILDKIT=0 docker compose -f docker/docker-compose.yml --env-file .env build --no-cache --pull frontend
          
          # Start all containers
          echo "üöÄ Starting all containers..."
          docker compose -f docker/docker-compose.yml --env-file .env up -d
          
          # Wait for containers
          echo "‚è≥ Waiting for containers to initialize..."
          sleep 15
          
          # Check container status
          echo "üìä Container status:"
          docker compose -f docker/docker-compose.yml ps
          
          # Verify new code is deployed
          echo "üîç Checking if new code is in build..."
          if docker compose -f docker/docker-compose.yml exec frontend grep -r "Header rendered, current language" /usr/share/nginx/html/static/js/ >/dev/null 2>&1; then
              echo "‚úÖ New debug code found in build!"
          else
              echo "‚ùå Debug code NOT found - build might have failed"
              exit 1
          fi
          
          # Clean up old images
          echo "üßπ Final cleanup..."
          docker image prune -f || true
          
          echo "üéâ Deployment completed successfully!"
        EOF
        
    - name: Verify deployment
      run: |
        # Wait a moment for containers to start
        sleep 30
        
        # Check if API is responding
        if curl -f https://api.notionlock.com/api/health; then
          echo "‚úÖ API is healthy"
        else
          echo "‚ùå API health check failed"
          exit 1
        fi
        
        # Check if frontend is responding
        if curl -f https://notionlock.com; then
          echo "‚úÖ Frontend is responding"
        else
          echo "‚ùå Frontend check failed"
          exit 1
        fi